<?xml version="1.0" encoding="UTF-8"?>
<jasperReport xmlns="http://jasperreports.sourceforge.net/jasperreports" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://jasperreports.sourceforge.net/jasperreports http://jasperreports.sourceforge.net/xsd/jasperreport.xsd" name="relatorio_ingressos" pageWidth="595" pageHeight="842" columnWidth="555" leftMargin="20" rightMargin="20" topMargin="20" bottomMargin="20" uuid="a1c2b8e3-0b1a-4b9e-9b0e-3e2c1d0a9f8b">
    <property name="ireport.zoom" value="1.5"/>
    <property name="ireport.x" value="0"/>
    <property name="ireport.y" value="0"/>
    <style name="Title" fontName="Arial" fontSize="26" isBold="true"/>
    <style name="SubTitle" fontName="Arial" fontSize="18"/>
    <style name="ColumnHeader" fontName="Arial" fontSize="12" isBold="true"/>
    <style name="Detail" fontName="Arial" fontSize="11"/>
    <style name="GroupHeader" fontName="Arial" fontSize="14" isBold="true" backcolor="#E6E6E6"/>

    <subDataset name="dataset_receita" uuid="1c8f2a2d-2b8e-4b2a-8b2e-2f2b2e8e2b8e">
        <field name="MUSEU_NOME" class="java.lang.String"/>
        <field name="RECEITA_TOTAL" class="java.lang.Double"/>
    </subDataset>
    <subDataset name="dataset_tipo" uuid="fba8340c-1b32-4e23-912b-3e5f22c67623">
        <field name="TIPO_INGRESSO" class="java.lang.String"/>
        <field name="TOTAL_TIPO" class="java.lang.Integer"/>
    </subDataset>

    <parameter name="DADOS_GRAFICO_RECEITA" class="net.sf.jasperreports.engine.JRDataSource"/>
    <parameter name="DADOS_GRAFICO_TIPO" class="net.sf.jasperreports.engine.JRDataSource"/>

    <queryString>
        <![CDATA[
            SELECT
                i.codIngresso, i.tipo, i.preco, v.dataVisita,
                vs.nome AS nome_visitante, m.nome AS nome_museu
            FROM ingressos i
            JOIN visitas v ON i.Visitas_codVisita = v.codVisita
            JOIN visitantes vs ON v.Visitantes_codVisitante = vs.codVisitante
            JOIN museus m ON i.Museus_codMuseu = m.codMuseu
            ORDER BY m.nome, v.dataVisita
        ]]>
    </queryString>
    <field name="codIngresso" class="java.lang.Integer"/>
    <field name="tipo" class="java.lang.String"/>
    <field name="preco" class="java.lang.Double"/>
    <field name="dataVisita" class="java.sql.Date"/>
    <field name="nome_visitante" class="java.lang.String"/>
    <field name="nome_museu" class="java.lang.String"/>

    <variable name="RECEITA_POR_MUSEU" class="java.lang.Double" resetType="Group" resetGroup="MuseuGroup" calculation="Sum">
        <variableExpression><![CDATA[$F{preco}]]></variableExpression>
    </variable>
    <variable name="RECEITA_TOTAL" class="java.lang.Double" calculation="Sum">
        <variableExpression><![CDATA[$F{preco}]]></variableExpression>
    </variable>

    <group name="MuseuGroup">
        <groupExpression><![CDATA[$F{nome_museu}]]></groupExpression>
        <groupHeader>
            <band height="25">
                <textField>
                    <reportElement style="GroupHeader" mode="Opaque" x="0" y="0" width="555" height="25" uuid="f5b3a8e9-2b0e-4b8e-9c1a-3e2c1d0a9f8b"/>
                    <textElement verticalAlignment="Middle"/>
                    <textFieldExpression><![CDATA["  Museu: " + $F{nome_museu}]]></textFieldExpression>
                </textField>
            </band>
        </groupHeader>
        <groupFooter>
            <band height="20">
                <textField pattern="¤ #,##0.00">
                    <reportElement style="ColumnHeader" x="455" y="0" width="100" height="20" uuid="a1c2b8e3-0b1a-4b9e-9b0e-3e2c1d0a9f8b"/>
                    <textElement textAlignment="Right" verticalAlignment="Middle"/>
                    <textFieldExpression><![CDATA[$V{RECEITA_POR_MUSEU}]]></textFieldExpression>
                </textField>
                <textField>
                    <reportElement style="ColumnHeader" x="305" y="0" width="150" height="20" uuid="b1c2b8e3-0b1a-4b9e-9b0e-3e2c1d0a9f8b"/>
                    <textElement textAlignment="Right" verticalAlignment="Middle"/>
                    <textFieldExpression><![CDATA["Receita do Museu ("+$V{MuseuGroup_COUNT}+" ingressos):"]]></textFieldExpression>
                </textField>
            </band>
        </groupFooter>
    </group>

    <title>
        <band height="70" splitType="Stretch">
            <staticText>
                <reportElement style="Title" x="0" y="0" width="555" height="40" uuid="c1c2b8e3-0b1a-4b9e-9b0e-3e2c1d0a9f8b"/>
                <textElement textAlignment="Center" verticalAlignment="Middle"/>
                <text><![CDATA[Relatório de Venda de Ingressos]]></text>
            </staticText>
            <textField pattern="dd/MM/yyyy HH:mm">
                <reportElement style="SubTitle" x="0" y="40" width="555" height="30" forecolor="#666666" uuid="d1c2b8e3-0b1a-4b9e-9b0e-3e2c1d0a9f8b"/>
                <textElement textAlignment="Center" verticalAlignment="Middle"/>
                <textFieldExpression><![CDATA["Gerado em: " + new java.util.Date()]]></textFieldExpression>
            </textField>
        </band>
    </title>
    <columnHeader>
        <band height="25" splitType="Stretch">
            <staticText>
                <reportElement style="ColumnHeader" mode="Opaque" x="0" y="0" width="255" height="25" forecolor="#FFFFFF" backcolor="#4CAF50" uuid="f1c2b8e3-0b1a-4b9e-9b0e-3e2c1d0a9f8b"/>
                <textElement verticalAlignment="Middle"/>
                <text><![CDATA[  Visitante]]></text>
            </staticText>
            <staticText>
                <reportElement style="ColumnHeader" mode="Opaque" x="255" y="0" width="100" height="25" forecolor="#FFFFFF" backcolor="#4CAF50" uuid="a2c2b8e3-0b1a-4b9e-9b0e-3e2c1d0a9f8b"/>
                <textElement textAlignment="Center" verticalAlignment="Middle"/>
                <text><![CDATA[Data da Visita]]></text>
            </staticText>
            <staticText>
                <reportElement style="ColumnHeader" mode="Opaque" x="355" y="0" width="100" height="25" forecolor="#FFFFFF" backcolor="#4CAF50" uuid="e1c2b8e3-0b1a-4b9e-9b0e-3e2c1d0a9f8b"/>
                <textElement textAlignment="Center" verticalAlignment="Middle"/>
                <text><![CDATA[Tipo]]></text>
            </staticText>
            <staticText>
                <reportElement style="ColumnHeader" mode="Opaque" x="455" y="0" width="100" height="25" forecolor="#FFFFFF" backcolor="#4CAF50" uuid="b2c2b8e3-0b1a-4b9e-9b0e-3e2c1d0a9f8b"/>
                <textElement textAlignment="Right" verticalAlignment="Middle"/>
                <text><![CDATA[Preço ]]></text>
            </staticText>
        </band>
    </columnHeader>
    <detail>
        <band height="20" splitType="Stretch">
            <textField>
                <reportElement style="Detail" x="0" y="0" width="255" height="20" uuid="d2c2b8e3-0b1a-4b9e-9b0e-3e2c1d0a9f8b"/>
                <textElement verticalAlignment="Middle"/>
                <textFieldExpression><![CDATA["  " + $F{nome_visitante}]]></textFieldExpression>
            </textField>
            <textField pattern="dd/MM/yyyy">
                <reportElement style="Detail" x="255" y="0" width="100" height="20" uuid="e2c2b8e3-0b1a-4b9e-9b0e-3e2c1d0a9f8b"/>
                <textElement textAlignment="Center" verticalAlignment="Middle"/>
                <textFieldExpression><![CDATA[$F{dataVisita}]]></textFieldExpression>
            </textField>
            <textField>
                <reportElement style="Detail" x="355" y="0" width="100" height="20" uuid="f2c2b8e3-0b1a-4b9e-9b0e-3e2c1d0a9f8b"/>
                <textElement textAlignment="Center" verticalAlignment="Middle"/>
                <textFieldExpression><![CDATA[$F{tipo}]]></textFieldExpression>
            </textField>
            <textField pattern="¤ #,##0.00">
                <reportElement style="Detail" x="455" y="0" width="100" height="20" uuid="c2c2b8e3-0b1a-4b9e-9b0e-3e2c1d0a9f8b"/>
                <textElement textAlignment="Right" verticalAlignment="Middle"/>
                <textFieldExpression><![CDATA[$F{preco}]]></textFieldExpression>
            </textField>
        </band>
    </detail>
    <summary>
        <band height="300" splitType="Stretch">
            <textField pattern="¤ #,##0.00">
                <reportElement style="Title" x="455" y="10" width="100" height="30" uuid="a3c2b8e3-0b1a-4b9e-9b0e-3e2c1d0a9f8b"/>
                <textElement textAlignment="Right" verticalAlignment="Middle"/>
                <textFieldExpression><![CDATA[$V{RECEITA_TOTAL}]]></textFieldExpression>
            </textField>
            <staticText>
                <reportElement style="Title" x="255" y="10" width="200" height="30" uuid="b3c2b8e3-0b1a-4b9e-9b0e-3e2c1d0a9f8b"/>
                <textElement textAlignment="Right" verticalAlignment="Middle"/>
                <text><![CDATA[Receita Total:]]></text>
            </staticText>
            <pieChart>
                <chart>
                    <reportElement x="335" y="50" width="220" height="250" uuid="c3c2b8e3-0b1a-4b9e-9b0e-3e2c1d0a9f8b"/>
                    <chartTitle>
                        <titleExpression><![CDATA["Vendas por Tipo de Ingresso"]]></titleExpression>
                    </chartTitle>
                    <chartSubtitle/>
                    <chartLegend/>
                </chart>
                <pieDataset>
                    <dataset>
                        <datasetRun subDataset="dataset_tipo" uuid="d3c2b8e3-0b1a-4b9e-9b0e-3e2c1d0a9f8b">
                            <dataSourceExpression><![CDATA[$P{DADOS_GRAFICO_TIPO}]]></dataSourceExpression>
                        </datasetRun>
                    </dataset>
                    <keyExpression><![CDATA[$F{TIPO_INGRESSO}]]></keyExpression>
                    <valueExpression><![CDATA[$F{TOTAL_TIPO}]]></valueExpression>
                    <labelExpression><![CDATA[$F{TIPO_INGRESSO} + " (" + $F{TOTAL_TIPO} + ")"]]></labelExpression>
                </pieDataset>
                <piePlot>
                    <plot/>
                    <itemLabel/>
                </piePlot>
            </pieChart>
            <barChart>
                <chart>
                    <reportElement x="0" y="50" width="324" height="250" uuid="c3c2b8e3-0b1a-4b9e-9b0e-3e2c1d0a9f8b"/>
                    <chartTitle>
                        <titleExpression><![CDATA["Receita por Museu"]]></titleExpression>
                    </chartTitle>
                    <chartSubtitle/>
                    <chartLegend position="Bottom"/>
                </chart>
                <categoryDataset>
                    <dataset>
                        <datasetRun subDataset="dataset_receita" uuid="d3c2b8e3-0b1a-4b9e-9b0e-3e2c1d0a9f8b">
                            <dataSourceExpression><![CDATA[$P{DADOS_GRAFICO_RECEITA}]]></dataSourceExpression>
                        </datasetRun>
                    </dataset>
                    <categorySeries>
                        <seriesExpression><![CDATA["Receita (R$)"]]></seriesExpression>
                        <categoryExpression><![CDATA[$F{MUSEU_NOME}]]></categoryExpression>
                        <valueExpression><![CDATA[$F{RECEITA_TOTAL}]]></valueExpression>
                    </categorySeries>
                </categoryDataset>
                <barPlot>
                    <plot/>
                    <itemLabel/>
                    <categoryAxisFormat>
                        <axisFormat/>
                    </categoryAxisFormat>
                    <valueAxisFormat>
                        <axisFormat/>
                    </valueAxisFormat>
                </barPlot>
            </barChart>
        </band>
    </summary>
</jasperReport>